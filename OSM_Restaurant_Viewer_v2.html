<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Restaurantsuche mit vegan Filter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    details {
      margin-bottom: 15px;
    }
    summary {
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
    }
    td {
      padding: 4px 8px;
      border-bottom: 1px solid #ddd;
    }
    .loading {
      color: gray;
    }
    .error {
      color: red;
    }
    .pagination {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .pagination button {
      padding: 5px 10px;
      font-size: 1em;
    }
    #search-container {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    input[type="text"] {
      flex: 1;
      padding: 5px;
      font-size: 1em;
    }
    label {
      font-size: 0.95em;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h1>üçΩÔ∏è Restaurantsuche</h1>
  <div id="search-container">
    <input id="search-input" type="text" placeholder="üîç Suche nach Name oder K√ºche..." />
    <label><input type="checkbox" id="vegan-checkbox" /> nur vegane Optionen</label>
  </div>
  <p id="status" class="loading">Lade Daten...</p>
  <div id="restaurant-list"></div>
  <div class="pagination">
    <button id="prev-page">‚¨ÖÔ∏è Zur√ºck</button>
    <span id="page-info"></span>
    <button id="next-page">Weiter ‚û°Ô∏è</button>
  </div>

  <script>
    const relationId = getRelationIdFromURL() || 62352; // Leipzig (default)
    const pageSize = 25;
    let allRestaurants = [];
    let filteredRestaurants = [];
    let currentPage = 1;

    const status = document.getElementById("status");
    const listContainer = document.getElementById("restaurant-list");
    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const pageInfo = document.getElementById("page-info");
    const searchInput = document.getElementById("search-input");
    const veganCheckbox = document.getElementById("vegan-checkbox");

    function getRelationIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("relation_id");
    }

    function getCacheKey(relationId) {
      return `osm_restaurants_${relationId}`;
    }

    function getCachedData(relationId) {
      const entry = localStorage.getItem(getCacheKey(relationId));
      if (!entry) return null;

      try {
        const { data, timestamp } = JSON.parse(entry);
        const age = Date.now() - timestamp;
        const oneDay = 24 * 60 * 60 * 1000;
        if (age > oneDay) {
          localStorage.removeItem(getCacheKey(relationId));
          return null;
        }
        return data;
      } catch (e) {
        return null;
      }
    }

    function cacheData(relationId, data) {
      localStorage.setItem(getCacheKey(relationId), JSON.stringify({
        data,
        timestamp: Date.now()
      }));
    }

    async function fetchRestaurants(relationId) {
      const cached = getCachedData(relationId);
      if (cached) {
        console.log("[Cache] Verwendet");
        return cached;
      }

      const query = `
        [out:json][timeout:60];
        relation(${relationId});
        map_to_area -> .searchArea;
        (
          node["amenity"="restaurant"](area.searchArea);
          way["amenity"="restaurant"](area.searchArea);
          relation["amenity"="restaurant"](area.searchArea);
        );
        out tags center;
      `;

      const response = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: new URLSearchParams({ data: query })
      });

      if (!response.ok) throw new Error("Fehler bei der Overpass API");

      const data = await response.json();
      cacheData(relationId, data.elements);
      return data.elements || [];
    }

    function renderRestaurant(el) {
      const tags = el.tags || {};
      const name = tags.name || "Unbenanntes Restaurant";

      const info = {
        "Adresse": [tags["addr:street"], tags["addr:housenumber"], tags["addr:postcode"], tags["addr:city"]]
          .filter(Boolean).join(" "),
        "Telefon": tags["contact:phone"] || tags["phone"] || "",
        "Website": tags["contact:website"] || tags["website"] || "",
        "√ñffnungszeiten": tags["opening_hours"] || "",
        "Rollstuhlzugang": tags["wheelchair"] || "",
        "Rollstuhl-WC": tags["toilets:wheelchair"] || "",
        "K√ºche": tags["cuisine"] || "",
        "Vegetarisch": tags["diet:vegetarian"] || "",
        "Vegan": tags["diet:vegan"] || "",
        "Au√üensitzpl√§tze": tags["outdoor_seating"] || ""
      };

      const tableRows = Object.entries(info)
        .map(([key, value]) => `<tr><td><strong>${key}</strong></td><td>${value || "-"}</td></tr>`)
        .join("");

      return `
        <details>
          <summary>${name}</summary>
          <table>${tableRows}</table>
        </details>
      `;
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredRestaurants.length / pageSize);
      pageInfo.textContent = `Seite ${currentPage} von ${totalPages}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    function renderPage() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageItems = filteredRestaurants.slice(start, end);
      listContainer.innerHTML = pageItems.map(renderRestaurant).join("");
      updatePagination();
    }

    function applyFilter() {
      const term = searchInput.value.toLowerCase().trim();
      const veganOnly = veganCheckbox.checked;

      filteredRestaurants = allRestaurants.filter(el => {
        const tags = el.tags || {};
        const name = tags.name || "";
        const cuisine = tags.cuisine || "";
        const matchesSearch = !term || name.toLowerCase().includes(term) || cuisine.toLowerCase().includes(term);
        const matchesVegan = !veganOnly || (tags["diet:vegan"] && ["yes", "only"].includes(tags["diet:vegan"].toLowerCase()));
        return matchesSearch && matchesVegan;
      });

      currentPage = 1;
      renderPage();
    }

    async function init() {
      try {
        const elements = await fetchRestaurants(relationId);
        allRestaurants = elements;
        status.textContent = `Gefundene Restaurants: ${elements.length}`;
        applyFilter();
      } catch (err) {
        console.error(err);
        status.textContent = "Fehler beim Laden der Daten.";
        status.className = "error";
      }
    }

    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    });

    nextBtn.addEventListener("click", () => {
      const totalPages = Math.ceil(filteredRestaurants.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderPage();
      }
    });

    searchInput.addEventListener("input", applyFilter);
    veganCheckbox.addEventListener("change", applyFilter);

    init();
  </script>
</body>
</html>
